<div class="section">
  <div class="form-row">
    <div class="flex items-center gap-2">
      <label class="w-40 font-semibold">Form 30</label>
      <button mat-raised-button color="primary" (click)="openForm30Popup($event)">
        <mat-icon>link</mat-icon>
        Link
      </button>
    </div>
    <div class="form-group flex-1">
      <div class="relative h-14">
        <select
          id="businessUnit"
          formControlName="businessUnit"
          required
          class="w-full h-full px-4 bg-gray-100 rounded border-b-2 border-gray-300 focus:border-blue-500 focus:outline-none focus:bg-white transition appearance-none"
        >
          @for (unit of BuildingUnit | keyvalue; track unit.key) {
            <option [value]="unit.key">{{ unit.value }}</option>
          }
        </select>
        <label
          for="businessUnit"
          class="absolute left-4 top-1 text-xs text-gray-500 pointer-events-none"
        >
          Business Unit
        </label>
      </div>
    </div>
    <div class="form-group flex-1">
      <div class="relative h-14">
        <input
          type="date"
          id="dueDate"
          formControlName="dueDate"
          class="w-full h-full px-4 bg-gray-100 rounded border-b-2 border-gray-300 focus:border-blue-500 focus:outline-none focus:bg-white transition"
          style="color: transparent; caret-color: transparent"
        />
        <div class="absolute top-0 left-0 w-full h-full flex items-center pointer-events-none pl-4">
          @if (formGroup.get('dueDate')?.value) {
            <span class="text-gray-900 font-medium">{{
              formGroup.get('dueDate')?.value | date: 'dd MMM yyyy' | uppercase
            }}</span>
          } @else {
            <span class="text-gray-500">Due Date</span>
          }
        </div>
      </div>
    </div>
  </div>

  <div class="form-row">
    <div class="form-group flex-1">
      <div class="relative h-14">
        <input
          id="tenderNo"
          formControlName="tenderNo"
          [disabled]="true"
          readonly
          placeholder="Tender No"
          class="w-full h-full px-4 bg-gray-100 rounded border-b-2 border-gray-300 focus:border-blue-500 focus:outline-none focus:bg-white transition"
        />
        <div
          style="
            position: absolute;
            right: 0;
            top: 0;
            height: 100%;
            display: flex;
            align-items: center;
            gap: 8px;
          "
        >
          @if (!formGroup.get('tenderNo')?.value || formGroup.get('tenderNo')?.value === 'NEW') {
            <button
              (click)="allocateTenderNo()"
              [disabled]="!formGroup.get('businessUnit')?.value || !formGroup.get('dueDate')?.value || !formGroup.get('projectTitle')?.value || allocatingTenderNo"
              [matTooltip]="!formGroup.get('businessUnit')?.value || !formGroup.get('dueDate')?.value || !formGroup.get('projectTitle')?.value ? 'Fill Business Unit, Due Date, and Project Title first' : ''"
              matTooltipPosition="above"
              type="button"
              [ngClass]="{
                'bg-blue-500 text-white hover:bg-blue-600 border-blue-600 shadow-md': formGroup.get('businessUnit')?.value && formGroup.get('dueDate')?.value && formGroup.get('projectTitle')?.value && !allocatingTenderNo,
                'bg-gray-300 text-gray-500 border-gray-400 cursor-not-allowed': !formGroup.get('businessUnit')?.value || !formGroup.get('dueDate')?.value || !formGroup.get('projectTitle')?.value || allocatingTenderNo
              }"
              class="border px-4 py-2 rounded font-medium transition-all duration-200"
            >
              Allocate Tender No
            </button>
          }
        </div>
      </div>
    </div>
    <div class="form-group flex-1">
      <div class="relative h-14">
        <input
          id="projectTitle"
          formControlName="projectTitle"
          required
          placeholder=" "
          class="w-full h-full px-4 bg-gray-100 rounded border-b-2 border-gray-300 focus:border-blue-500 focus:outline-none focus:bg-white transition peer"
        />
        <label
          for="projectTitle"
          class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500 transition-all pointer-events-none peer-focus:top-2 peer-focus:text-xs peer-focus:text-blue-500 peer-[:not(:placeholder-shown)]:top-2 peer-[:not(:placeholder-shown)]:text-xs"
        >
          Project Title
        </label>
      </div>
    </div>
  </div>

  <div class="form-row">
    <div class="form-group flex-1">
      <div class="relative h-14">
        <input
          id="BidManager"
          [formControl]="bidManagerSearchCtrl"
          placeholder=" "
          class="w-full h-full px-4 bg-gray-100 rounded border-b-2 border-gray-300 focus:border-blue-500 focus:outline-none focus:bg-white transition peer"
        />
        <label
          for="BidManager"
          class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500 transition-all pointer-events-none peer-focus:top-2 peer-focus:text-xs peer-focus:text-blue-500 peer-[:not(:placeholder-shown)]:top-2 peer-[:not(:placeholder-shown)]:text-xs"
        >
          Bid Manager
        </label>
        
        @if (bidManagerSearchResults.length > 0 && bidManagerSearchCtrl.value && bidManagerSearchCtrl.value.length >= 4) {
          <div class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto">
            @for (user of bidManagerSearchResults; track user.employeeNo) {
              <div 
                (click)="selectBidManager(user)"
                class="px-4 py-2 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-b-0"
              >
                <div class="font-medium">{{user.fullName}}</div>
                <div class="text-sm text-gray-600">{{user.title}}</div>
              </div>
            }
          </div>
        }
      </div>
    </div>
    <div class="form-group flex-1">
      <div class="relative h-14">
        <input
          id="Estimator"
          formControlName="Estimator"
          placeholder=" "
          class="w-full h-full px-4 bg-gray-100 rounded border-b-2 border-gray-300 focus:border-blue-500 focus:outline-none focus:bg-white transition peer"
        />
        <label
          for="Estimator"
          class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500 transition-all pointer-events-none peer-focus:top-2 peer-focus:text-xs peer-focus:text-blue-500 peer-[:not(:placeholder-shown)]:top-2 peer-[:not(:placeholder-shown)]:text-xs"
        >
          Estimator
        </label>
      </div>
    </div>
    <div class="form-group flex-1">
      <div class="relative h-14">
        <input
          id="Planner"
          [formControl]="plannerSearchCtrl"
          placeholder=" "
          class="w-full h-full px-4 bg-gray-100 rounded border-b-2 border-gray-300 focus:border-blue-500 focus:outline-none focus:bg-white transition peer"
        />
        <label
          for="Planner"
          class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500 transition-all pointer-events-none peer-focus:top-2 peer-focus:text-xs peer-focus:text-blue-500 peer-[:not(:placeholder-shown)]:top-2 peer-[:not(:placeholder-shown)]:text-xs"
        >
          Planner
        </label>
        
        @if (plannerSearchResults.length > 0 && plannerSearchCtrl.value && plannerSearchCtrl.value.length >= 4) {
          <div class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto">
            @for (user of plannerSearchResults; track user.employeeNo) {
              <div 
                (click)="selectPlanner(user)"
                class="px-4 py-2 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-b-0"
              >
                <div class="font-medium">{{user.fullName}}</div>
                <div class="text-sm text-gray-600">{{user.title}}</div>
              </div>
            }
          </div>
        }
      </div>
    </div>
  </div>

  <div class="form-row">
    <div class="form-group flex-1">
      <div class="relative h-14">
        <select
          id="Region"
          formControlName="Region"
          class="w-full h-full px-4 bg-gray-100 rounded border-b-2 border-gray-300 focus:border-blue-500 focus:outline-none focus:bg-white transition appearance-none"
        >
          @for (region of regions | keyvalue; track region.key) {
            <option [value]="+region.key">{{ region.value }}</option>
          }
        </select>
        <div
          class="absolute top-0 left-0 w-full h-full flex items-center pl-4"
          style="pointer-events: none; z-index: 1"
        >
          <label
            for="Region"
            class="absolute left-4 top-1 text-xs text-gray-500 pointer-events-none"
          >
            Region
          </label>
        </div>
      </div>
    </div>
    <div class="form-group flex-1">
      <div class="relative h-14">
        <input
          id="Location"
          formControlName="Location"
          placeholder=" "
          class="w-full h-full px-4 bg-gray-100 rounded border-b-2 border-gray-300 focus:border-blue-500 focus:outline-none focus:bg-white transition peer"
        />
        <label
          for="Location"
          class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500 transition-all pointer-events-none peer-focus:top-2 peer-focus:text-xs peer-focus:text-blue-500 peer-[:not(:placeholder-shown)]:top-2 peer-[:not(:placeholder-shown)]:text-xs"
        >
          Location
        </label>
      </div>
    </div>
    <div class="form-group flex-1">
      <div class="relative h-14">
        <select
          id="TenderType"
          formControlName="TenderType"
          class="w-full h-full px-4 bg-gray-100 rounded border-b-2 border-gray-300 focus:border-blue-500 focus:outline-none focus:bg-white transition appearance-none"
        >
          @for (tenderType of tenderTypes | keyvalue; track tenderType.key) {
            <option [value]="+tenderType.key">{{ tenderType.value }}</option>
          }
        </select>
        <label
          for="TenderType"
          class="absolute left-4 top-1 text-xs text-gray-500 pointer-events-none"
        >
          Tender Type
        </label>
      </div>
    </div>
  </div>

  <div class="form-row flex items-start gap-4">
    <div class="flex items-center min-w-[180px] mr-2">
      <div class="font-bold">Brief Description:</div>
    </div>
    <div class="flex-1">
      <textarea
        id="BriefDescription"
        formControlName="BriefDescription"
        rows="3"
        class="w-full px-4 bg-gray-100 rounded border-b-2 border-gray-300 focus:border-blue-500 focus:outline-none focus:bg-white transition"
      ></textarea>
    </div>
  </div>

  <div class="form-row">
    <div class="mb-4 mr-2">
      <div class="mb-2 font-bold">Approximate Value:</div>
    </div>
    <div style="display: flex; gap: 10px">
      <div class="form-group flex-1">
        <div class="relative h-14">
          <select
            id="ApproximateValueType"
            formControlName="ApproximateValueType"
            class="w-full h-full px-4 bg-gray-100 rounded border-b-2 border-gray-300 focus:border-blue-500 focus:outline-none focus:bg-white transition appearance-none"
          >
            @for (currency of currencies | keyvalue; track currency.key) {
              <option [value]="+currency.key">{{ currency.value }}</option>
            }
          </select>
        </div>
      </div>
      <div class="form-group" style="flex: 1">
        <div class="relative h-14">
          <input
            id="ApproximateValueInput"
            formControlName="ApproximateValueInput"
            placeholder=""
            class="w-full h-full px-4 bg-gray-100 rounded border-b-2 border-gray-300 focus:border-blue-500 focus:outline-none focus:bg-white transition peer"
          />
          <label
            for="ApproximateValueInput"
            class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500 transition-all pointer-events-none peer-focus:top-2 peer-focus:text-xs peer-focus:text-blue-500 peer-[:not(:placeholder-shown)]:top-2 peer-[:not(:placeholder-shown)]:text-xs"
          >
            e.g. 30M, 5B
          </label>
        </div>
      </div>
    </div>
  </div>

  <div class="form-row">
    <div class="mb-4 mr-2">
      <div class="mb-2 font-bold">Approximate Value Remarks:</div>
    </div>
    <div class="form-group flex-1">
      <div class="relative h-14">
        <input
          id="ApproximateValue"
          formControlName="ApproximateValue"
          class="w-full h-full px-4 bg-gray-100 rounded border-b-2 border-gray-300 focus:border-blue-500 focus:outline-none focus:bg-white transition"
        />
      </div>
    </div>
    <div class="mb-4 mr-2">
      <div class="mb-2 font-bold">Approximate Margin:</div>
    </div>
    <div class="form-group flex-1">
      <div class="relative h-14">
        <input
          id="Approxmargin"
          formControlName="Approxmargin"
          placeholder=""
          class="w-full h-full px-4 bg-gray-100 rounded border-b-2 border-gray-300 focus:border-blue-500 focus:outline-none focus:bg-white transition peer"
        />
        <label
          for="Approxmargin"
          class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500 transition-all pointer-events-none peer-focus:top-2 peer-focus:text-xs peer-focus:text-blue-500 peer-[:not(:placeholder-shown)]:top-2 peer-[:not(:placeholder-shown)]:text-xs"
        >
          e.g. 1M, 100k
        </label>
      </div>
    </div>
  </div>

  <div class="form-row">
    <div class="mb-4 mr-2">
      <div class="mb-2 font-bold">Maintenance / Defect:</div>
    </div>
    <div style="display: flex; gap: 10px">
      <div class="form-group flex-1">
        <div class="relative h-14">
          <select
            id="maintenanceType"
            formControlName="maintenanceType"
            class="w-full h-full px-4 bg-gray-100 rounded border-b-2 border-gray-300 focus:border-blue-500 focus:outline-none focus:bg-white transition appearance-none"
          >
            @for (maintenanceDefect of maintenanceDefects | keyvalue; track maintenanceDefect.key) {
              <option [value]="+maintenanceDefect.key">{{ maintenanceDefect.value }}</option>
            }
          </select>
        </div>
      </div>
      <div class="form-group flex-1">
        <div class="relative h-14">
          <input
            id="maintenanceValue"
            type="number"
            formControlName="maintenanceValue"
            placeholder="Enter number"
            class="w-full h-full px-4 bg-gray-100 rounded border-b-2 border-gray-300 focus:border-blue-500 focus:outline-none focus:bg-white transition"
          />
        </div>
      </div>
      <div class="form-group flex-1">
        <div class="relative h-14">
          <select
            id="maintenanceStatus1"
            formControlName="maintenanceStatus1"
            class="w-full h-full px-4 bg-gray-100 rounded border-b-2 border-gray-300 focus:border-blue-500 focus:outline-none focus:bg-white transition appearance-none"
          >
            <option value="months">months</option>
            <option value="days">days</option>
            <option value="years">years</option>
            <option value="weeks">weeks</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <div class="form-row" style="display: flex; gap: 1rem; flex-wrap: wrap">
    <div class="mb-4 mr-2">
      <div class="mb-2 font-bold">Client:</div>
    </div>
    <div class="form-group" style="width: 580px">
      <div class="relative h-14">
        <input
          id="clientName"
          formControlName="clientName"
          class="w-full h-full px-4 bg-gray-100 rounded border-b-2 border-gray-300 focus:border-blue-500 focus:outline-none focus:bg-white transition"
        />
      </div>
    </div>

    <div class="mb-4 mr-2">
      <div class="mb-2 font-bold">Contract Period:</div>
    </div>

    <div class="form-group" style="width: 180px">
      <div class="relative h-14">
        <input
          id="contractPeriodValue"
          type="number"
          formControlName="contractPeriodValue"
          class="w-full h-full px-4 bg-gray-100 rounded border-b-2 border-gray-300 focus:border-blue-500 focus:outline-none focus:bg-white transition"
        />
      </div>
    </div>
    <!-- Contract Period Unit -->
    <div class="form-group" style="width: 180px">
      <div class="relative h-14">
        <select
          id="contractPeriodUnit"
          formControlName="contractPeriodUnit"
          class="w-full h-full px-4 bg-gray-100 rounded border-b-2 border-gray-300 focus:border-blue-500 focus:outline-none focus:bg-white transition appearance-none"
        >
          <option value="months">Months</option>
          <option value="days">Days</option>
          <option value="years">Years</option>
          <option value="weeks">Weeks</option>
        </select>
        <div
          class="absolute top-0 left-0 w-full h-full flex items-center pl-4"
          style="pointer-events: none; z-index: 1"
        >
          <span
            [ngClass]="{
              'text-gray-900 font-medium': formGroup.get('contractPeriodUnit')?.value,
              'text-gray-500': !formGroup.get('contractPeriodUnit')?.value,
            }"
            [style.opacity]="formGroup.get('contractPeriodUnit')?.value ? 0 : 1"
            style="color: #bdbdbd"
            >Contract Period Unit</span
          >
        </div>
      </div>
    </div>
  </div>

  <div class="form-row">
    <div class="mb-4 mr-2">
      <div class="mb-2 font-bold">Financial Standing</div>
    </div>
    <div class="form-group" style="width: 360px">
      <div class="relative h-14">
        <select
          id="FinantialStanding"
          formControlName="FinantialStanding"
          class="w-full h-full px-4 bg-gray-100 rounded border-b-2 border-gray-300 focus:border-blue-500 focus:outline-none focus:bg-white transition appearance-none"
        >
          @for (financeStanding of financeStandings | keyvalue; track financeStanding.key) {
            <option [value]="+financeStanding.key">{{ financeStanding.value }}</option>
          }
        </select>
      </div>
    </div>
    <div style="width: 255px"></div>
    <div class="form-group" style="width: 360px">
      <div class="relative h-14">
        <input
          id="ComplexContractPeriod"
          formControlName="ComplexContractPeriod"
          placeholder=" "
          class="w-full h-full px-4 bg-gray-100 rounded border-b-2 border-gray-300 focus:border-blue-500 focus:outline-none focus:bg-white transition peer"
        />
        <label
          for="ComplexContractPeriod"
          class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500 transition-all pointer-events-none peer-focus:top-2 peer-focus:text-xs peer-focus:text-blue-500 peer-[:not(:placeholder-shown)]:top-2 peer-[:not(:placeholder-shown)]:text-xs"
        >
          for complex contract Period
        </label>
      </div>
    </div>
  </div>

  <div class="form-row">
    <div class="form-row">
      <div class="mb-2 font-bold">Tender Market Scheme</div>
      <div class="flex gap-6">
        @for (key of yesNo | keyvalue; track key.key) {
          <label
            class="inline-flex items-center px-2 py-1 bg-gray-100 rounded border border-gray-300"
          >
            <input
              type="radio"
              formControlName="TenderMarketScheme"
              [value]="key.value"
              class="mr-2 accent-blue-600"
            />
            {{ key.value }}
          </label>
        }
      </div>
    </div>

    <div class="mb-4 mr-2">
      <div class="mb-2 font-bold">Financial/Technical Split Value:</div>
    </div>
    <div class="form-group">
      <div class="relative h-14" style="width: 180px">
        <select
          id="FinancialTechnicalSplitValue"
          formControlName="FinancialTechnicalSplitValue"
          class="w-full h-full px-4 bg-gray-100 rounded border-b-2 border-gray-300 focus:border-blue-500 focus:outline-none focus:bg-white transition appearance-none"
        >
          @for (split of financeTechnicalSplits | keyvalue; track split.key) {
            <option [value]="+split.key">{{ split.value }}</option>
          }
        </select>
      </div>
    </div>

    <div class="mb-4 mr-2">
      <div class="mb-2 font-bold">Bid Type</div>
    </div>
    <div class="form-group" style="width: 180px">
      <div class="relative h-14">
        <select
          id="BidType"
          formControlName="BidType"
          class="w-full h-full px-4 bg-gray-100 rounded border-b-2 border-gray-300 focus:border-blue-500 focus:outline-none focus:bg-white transition appearance-none"
          (change)="onBidTypeChange($event)"
        >
          @for (bidtype of bidTypes | keyvalue; track bidtype.key) {
            <option [value]="+bidtype.key">{{ bidtype.value }}</option>
          }
        </select>
      </div>
    </div>
  </div>

  <!-- JV Partner(s) field - shown only when bid type is Joint Venture Bid (value 2) -->
  <!-- Place this block outside of the previous form-row to avoid template issues -->
  @if (isJointVentureBid) {
    <div class="form-row">
      <!-- JV Partner(s) textarea with floating label style -->
      <div class="form-group flex-1">
        <div class="relative h-14">
          <textarea
            id="JvPartner"
            formControlName="JvPartner"
            rows="1"
            placeholder=" "
            class="w-full h-full px-4 pt-6 pb-2 bg-gray-100 rounded border-b-2 border-gray-300 focus:border-blue-500 focus:outline-none focus:bg-white transition peer resize-y"
          ></textarea>
          <label
            for="JvPartner"
            class="absolute left-4 top-2 text-xs text-gray-500 transition-all pointer-events-none peer-focus:text-blue-500"
          >
            JV Partner(s)
          </label>
        </div>
      </div>
      <!-- JV Split input with floating label style -->
      <div class="form-group flex-1">
        <div class="relative h-14">
          <input
            id="JvSplit"
            formControlName="JvSplit"
            placeholder=" "
            class="w-full h-full px-4 bg-gray-100 rounded border-b-2 border-gray-300 focus:border-blue-500 focus:outline-none focus:bg-white transition peer"
          />
          <label
            for="JvSplit"
            class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500 transition-all pointer-events-none peer-focus:top-2 peer-focus:text-xs peer-focus:text-blue-500 peer-[:not(:placeholder-shown)]:top-2 peer-[:not(:placeholder-shown)]:text-xs"
          >
            JV Split
          </label>
        </div>
      </div>
      <!-- JV Agreement in Place select with floating label style -->
      <div class="form-group flex-1">
        <div class="relative h-14">
          <select
            id="JvAgreement"
            formControlName="JvAgreement"
            class="w-full h-full px-4 bg-gray-100 rounded border-b-2 border-gray-300 focus:border-blue-500 focus:outline-none focus:bg-white transition appearance-none"
          >
            @for (jvAgreement of jvAgreementOptions | keyvalue; track jvAgreement.key) {
              <option [value]="+jvAgreement.key">{{ jvAgreement.value }}</option>
            }
          </select>
          <div
            class="absolute top-0 left-0 w-full h-full flex items-center pl-4"
            style="pointer-events: none; z-index: 1"
          >
            <span
              [ngClass]="{
                'text-gray-900 font-medium': formGroup.get('JvAgreement')?.value,
                'text-gray-500': !formGroup.get('JvAgreement')?.value,
              }"
              [style.opacity]="formGroup.get('JvAgreement')?.value ? 0 : 1"
              style="color: #bdbdbd"
              >JV Agreement in Place</span
            >
          </div>
        </div>
      </div>
    </div>
  }
</div>
